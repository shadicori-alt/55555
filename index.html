<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بسم الله - نظام التواصل الذكي</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .page { display: none; }
    .page.active { display: block; }
    .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 20px; margin: 5px 0; }
    .user { background: #3B82F6; color: white; align-self: flex-end; }
    .ai { background: #E5E7EB; color: #1F2937; align-self: flex-start; }
    .dark { background: #1f2937; color: white; }
    .dark .bg-white { background: #374151; }
    .dark .text-gray-800 { color: #e5e7eb; }
    .typing { opacity: 0.7; font-style: italic; }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Navbar -->
  <nav class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-40">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">بسم الله</h1>
      <div class="flex gap-2 md:gap-4 flex-wrap text-sm md:text-base">
        <button onclick="showPage('home')" class="hover:underline">الرئيسية</button>
        <button onclick="showPage('orders')" class="hover:underline">الطلبات</button>
        <button onclick="showPage('agents')" class="hover:underline">المناديب</button>
        <button onclick="showPage('products')" class="hover:underline">المنتجات</button>
        <button onclick="showPage('reports')" class="hover:underline">التقارير</button>
        <button onclick="showPage('messages')" class="hover:underline">الرسائل</button>
        <button onclick="showPage('ai')" class="hover:underline">الذكاء</button>
        <button onclick="showPage('settings')" class="hover:underline">الإعدادات</button>
        <button id="theme-btn" class="hover:underline"><i class="fas fa-moon"></i></button>
      </div>
    </div>
  </nav>

  <!-- Pages -->
  <div class="container mx-auto mt-8 px-4">

    <!-- Home -->
    <div id="home" class="page active">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <i class="fas fa-shopping-cart text-4xl text-blue-600 mb-2"></i>
          <h3 id="total-orders" class="text-2xl font-bold">0</h3>
          <p>طلبات اليوم</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <i class="fas fa-users text-4xl text-green-600 mb-2"></i>
          <h3 id="active-agents" class="text-2xl font-bold">0</h3>
          <p>مناديب نشطين</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <i class="fas fa-chart-line text-4xl text-purple-600 mb-2"></i>
          <h3 id="total-sales" class="text-2xl font-bold">ج.م 0</h3>
          <p>المبيعات</p>
        </div>
      </div>
    </div>

    <!-- Orders -->
    <div id="orders" class="page">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="flex justify-between mb-4">
          <h2 class="text-xl font-bold">الطلبات</h2>
          <button onclick="addOrder()" class="bg-blue-600 text-white px-4 py-2 rounded">+ طلب جديد</button>
        </div>
        <input type="text" placeholder="ابحث..." class="w-full p-3 border rounded-lg mb-4" onkeyup="filterTable('orders-table', this.value)">
        <table id="orders-table" class="w-full">
          <thead class="bg-gray-200"><tr><th>رقم</th><th>العميل</th><th>الحالة</th><th>السعر</th><th>إجراء</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Agents -->
    <div id="agents" class="page">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="flex justify-between mb-4">
          <h2 class="text-xl font-bold">المناديب</h2>
          <button onclick="addAgent()" class="bg-blue-600 text-white px-4 py-2 rounded">+ مندوب</button>
        </div>
        <div id="agents-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </div>
    </div>

    <!-- Products -->
    <div id="products" class="page">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="flex justify-between mb-4">
          <h2 class="text-xl font-bold">المنتجات</h2>
          <button onclick="addProduct()" class="bg-blue-600 text-white px-4 py-2 rounded">+ منتج</button>
        </div>
        <div id="products-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </div>
    </div>

    <!-- Reports -->
    <div id="reports" class="page">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-4">التقارير</h2>
        <canvas id="salesChart" height="100"></canvas>
      </div>
    </div>

    <!-- Messages -->
    <div id="messages" class="page">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-4">الرسائل</h2>
        <div id="messages-list" class="space-y-4"></div>
      </div>
    </div>

    <!-- AI -->
    <div id="ai" class="page">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-4">إعدادات Grok</h2>
        <input id="api-key" type="password" placeholder="xai-..." class="w-full p-3 border rounded-lg mb-2">
        <button onclick="saveAPIKey()" class="w-full bg-blue-600 text-white py-2 rounded-lg mb-2">حفظ</button>
        <input id="test-prompt" type="text" placeholder="اكتب سؤال..." class="w-full p-3 border rounded-lg mb-2">
        <button onclick="testAPI()" class="w-full bg-green-600 text-white py-2 rounded-lg">اختبار</button>
        <div id="test-result" class="mt-4 p-3 bg-gray-100 rounded-lg hidden"></div>
      </div>
    </div>

    <!-- Settings -->
    <div id="settings" class="page">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-4">الإعدادات</h2>
        <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded">تصدير البيانات</button>
        <button onclick="clearData()" class="bg-red-600 text-white px-4 py-2 rounded ml-2">مسح الكل</button>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <button id="chat-toggle" class="fixed bottom-6 left-6 bg-blue-600 text-white p-4 rounded-full shadow-lg z-50">
    <i class="fas fa-robot text-xl"></i>
    <span id="notif" class="absolute -top-1 -right-1 h-3 w-3 bg-red-500 rounded-full hidden"></span>
  </button>
  <div id="chat-window" class="fixed bottom-20 left-6 w-80 bg-white rounded-xl shadow-xl hidden flex flex-col z-50">
    <div class="bg-blue-600 text-white p-4 rounded-t-xl flex justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
        <div><p class="font-bold">Grok</p><p class="text-xs">متصل</p></div>
      </div>
      <button id="close-chat" class="text-white"><i class="fas fa-times"></i></button>
    </div>
    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto"></div>
    <div class="p-4 border-t">
      <div class="flex gap-2">
        <input id="chat-input" type="text" placeholder="اكتب..." class="flex-1 p-2 border rounded-lg">
        <button id="send-btn" class="bg-blue-600 text-white p-2 rounded-lg"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Data
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    let agents = JSON.parse(localStorage.getItem('agents')) || [];
    let products = JSON.parse(localStorage.getItem('products')) || [];
    let messages = JSON.parse(localStorage.getItem('messages')) || [];

    // Save
    function save() {
      localStorage.setItem('orders', JSON.stringify(orders));
      localStorage.setItem('agents', JSON.stringify(agents));
      localStorage.setItem('products', JSON.stringify(products));
      localStorage.setItem('messages', JSON.stringify(messages));
      updateDashboard();
    }

    // Dashboard
    function updateDashboard() {
      document.getElementById('total-orders').textContent = orders.length;
      document.getElementById('active-agents').textContent = agents.filter(a => a.status === 'نشط').length;
      document.getElementById('total-sales').textContent = `ج.م ${orders.reduce((s, o) => s + o.price, 0)}`;
    }

    // Page
    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'orders') renderOrders();
      if (id === 'agents') renderAgents();
      if (id === 'products') renderProducts();
      if (id === 'messages') renderMessages();
      if (id === 'reports') renderChart();
    }

    // Orders
    function renderOrders() {
      const tbody = document.querySelector('#orders-table tbody');
      tbody.innerHTML = '';
      orders.forEach((o, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${o.id}</td>
          <td class="p-2">${o.client}</td>
          <td class="p-2">
            <select onchange="updateOrder(${i}, 'status', this.value)" class="p-1 border rounded">
              <option ${o.status==='جديد'?'selected':''}>جديد</option>
              <option ${o.status==='قيد التنفيذ'?'selected':''}>قيد التنفيذ</option>
              <option ${o.status==='تم التسليم'?'selected':''}>تم التسليم</option>
            </select>
          </td>
          <td class="p-2">${o.price}</td>
          <td class="p-2"><button onclick="deleteOrder(${i})" class="text-red-600">حذف</button></td>
        `;
        tbody.appendChild(tr);
      });
    }
    function addOrder() {
      const client = prompt('اسم العميل:');
      const price = parseInt(prompt('السعر:'));
      if (client && price) {
        orders.push({ id: orders.length + 1, client, status: 'جديد', price });
        save(); renderOrders();
      }
    }
    function updateOrder(i, key, val) { orders[i][key] = val; save(); }
    function deleteOrder(i) { if (confirm('حذف؟')) { orders.splice(i,1); save(); renderOrders(); }}

    // Agents
    function renderAgents() {
      const list = document.getElementById('agents-list');
      list.innerHTML = '';
      agents.forEach((a, i) => {
        const div = document.createElement('div');
        div.className = 'p-4 border rounded-lg text-center';
        div.innerHTML = `
          <div class="w-16 h-16 bg-gray-300 rounded-full mx-auto mb-2"></div>
          <p class="font-semibold">${a.name}</p>
          <p class="text-sm ${a.status==='نشط'?'text-green-600':'text-red-600'}">${a.status}</p>
          <button onclick="toggleAgent(${i})" class="text-xs bg-blue-600 text-white px-2 py-1 rounded mt-2">
            ${a.status==='نشط'?'إيقاف':'تفعيل'}
          </button>
        `;
        list.appendChild(div);
      });
    }
    function addAgent() {
      const name = prompt('اسم المندوب:');
      if (name) { agents.push({ name, status: 'نشط' }); save(); renderAgents(); }
    }
    function toggleAgent(i) {
      agents[i].status = agents[i].status === 'نشط' ? 'غير نشط' : 'نشط';
      save(); renderAgents();
    }

    // Products
    function renderProducts() {
      const list = document.getElementById('products-list');
      list.innerHTML = '';
      products.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'p-4 border rounded-lg';
        div.innerHTML = `
          <h3 class="font-semibold">${p.name}</h3>
          <p>السعر: ${p.price} ج.م</p>
          <p>المخزون: ${p.stock}</p>
          <button onclick="deleteProduct(${i})" class="text-red-600 text-xs">حذف</button>
        `;
        list.appendChild(div);
      });
    }
    function addProduct() {
      const name = prompt('اسم المنتج:');
      const price = prompt('السعر:');
      const stock = prompt('المخزون:');
      if (name && price && stock) {
        products.push({ name, price: parseInt(price), stock: parseInt(stock) });
        save(); renderProducts();
      }
    }
    function deleteProduct(i) { if (confirm('حذف؟')) { products.splice(i,1); save(); renderProducts(); }}

    // Messages
    function renderMessages() {
      const list = document.getElementById('messages-list');
      list.innerHTML = '';
      messages.forEach((m, i) => {
        const div = document.createElement('div');
        div.className = 'p-3 border rounded-lg';
        div.innerHTML = `
          <p class="font-semibold">${m.client}: ${m.text}</p>
          <p class="text-xs text-gray-500">${m.source} • ${m.time}</p>
          <textarea placeholder="الرد..." class="w-full p-2 border rounded mt-2"></textarea>
          <button onclick="sendReply(${i})" class="bg-blue-600 text-white px-3 py-1 rounded text-xs mt-1">إرسال</button>
        `;
        list.appendChild(div);
      });
    }
    function sendReply(i) {
      const textarea = document.querySelectorAll('textarea')[i];
      const reply = textarea.value;
      if (reply) {
        alert(`تم إرسال: "${reply}" إلى ${messages[i].client}`);
        textarea.value = '';
      }
    }

    // Reports
    function renderChart() {
      const ctx = document.getElementById('salesChart');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['الأسبوع 1', 'الأسبوع 2', 'الأسبوع 3'],
          datasets: [{ label: 'المبيعات', data: [12000, 19000, 45200], backgroundColor: '#3B82F6' }]
        }
      });
    }

    // Export / Clear
    function exportData() {
      const data = { orders, agents, products, messages };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'backup.json'; a.click();
    }
    function clearData() {
      if (confirm('مسح كل البيانات؟')) {
        orders = []; agents = []; products = []; messages = [];
        save();
        alert('تم المسح');
      }
    }

    // Grok API
    const GROK_URL = "https://api.x.ai/v1/chat/completions";
    async function callGrok(prompt) {
      const key = localStorage.getItem('grok_key');
      if (!key) throw new Error("احفظ المفتاح في صفحة الذكاء");
      const res = await fetch(GROK_URL, { method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
        body: JSON.stringify({ model: "grok-beta", messages: [{ role: "user", content: prompt }], temperature: 0.7 })
      });
      if (!res.ok) throw new Error("فشل الاتصال");
      const data = await res.json();
      return data.choices[0].message.content;
    }
    function saveAPIKey() {
      const key = document.getElementById('api-key').value.trim();
      if (key) { localStorage.setItem('grok_key', key); alert('تم الحفظ'); }
    }
    async function testAPI() {
      const prompt = document.getElementById('test-prompt').value;
      const result = document.getElementById('test-result');
      if (!prompt) return;
      result.classList.remove('hidden'); result.innerHTML = 'جاري...';
      try {
        const res = await callGrok(prompt);
        result.innerHTML = `<p class="font-bold">الرد:</p><p>${res}</p>`;
      } catch (e) { result.innerHTML = `<p class="text-red-600">${e.message}</p>`; }
    }

    // Chat
    const chatToggle = document.getElementById('chat-toggle');
    const chatWindow = document.getElementById('chat-window');
    const closeChat = document.getElementById('close-chat');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const notif = document.getElementById('notif');

    chatToggle.onclick = () => { chatWindow.classList.toggle('hidden'); notif.classList.add('hidden'); };
    closeChat.onclick = () => chatWindow.classList.add('hidden');
    sendBtn.onclick = sendMessage;
    chatInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());

    function addMsg(text, type) {
      const div = document.createElement('div');
      div.className = `chat-bubble ${type}`;
      div.textContent = text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return div;
    }
    async function sendMessage() {
      const msg = chatInput.value.trim();
      if (!msg) return;
      addMsg(msg, 'user');
      chatInput.value = '';
      const typing = addMsg('يكتب...', 'ai'); typing.classList.add('typing');
      try {
        const res = await callGrok(msg);
        typing.remove();
        addMsg(res, 'ai');
      } catch (e) {
        typing.remove();
        addMsg('خطأ: ' + e.message, 'ai');
      }
    }

    // Init
    save(); updateDashboard(); showPage('home');
    setTimeout(() => notif.classList.remove('hidden'), 3000);

    // Sample Data
    if (!orders.length) {
      orders = [{id:1,client:"محمد",status:"قيد التنفيذ",price:450}];
      agents = [{name:"أحمد",status:"نشط"}];
      products = [{name:"هاتف",price:5000,stock:10}];
      messages = [{client:"علي",text:"متى التوصيل؟",source:"واتساب",time:"منذ 5 دقائق"}];
      save();
    }
  </script>
</body>
</html>