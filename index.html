// public/app.js - الواجهة كاملة
let ws;
const settings = {};

// === تسجيل الدخول ===
function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            connectWebSocket();
            loadAllData();
        } else {
            alert('خطأ في البيانات');
        }
    });
}

// === WebSocket (wss لـ Vercel) ===
function connectWebSocket() {
    ws = new WebSocket(`wss://${location.host}`);
    ws.onopen = () => console.log('متصل');
    ws.onmessage = () => loadAllData();
    ws.onclose = () => setTimeout(connectWebSocket, 3000);
}

// === تحميل البيانات ===
async function loadAllData() {
    const [orders, agents, settingsRes] = await Promise.all([
        fetch('/api/orders').then(r => r.json()),
        fetch('/api/agents').then(r => r.json()),
        fetch('/api/settings').then(r => r.json())
    ]);
    Object.assign(settings, settingsRes);
    renderLinks();
    renderOrders(orders);
    renderAgents(agents);
}

// === الارتباطات ===
function renderLinks() {
    const fbStatus = document.getElementById('fb-status');
    fbStatus.textContent = settings.fb_page_name || 'غير متصل';
    fbStatus.className = settings.fb_token ? 'badge bg-success ms-2' : 'badge bg-secondary ms-2';

    document.getElementById('fb-connect').onclick = () => {
        const win = window.open('/auth/facebook', 'fb', 'width=600,height=700');
        const check = setInterval(() => {
            if (win.closed) { clearInterval(check); loadAllData(); }
        }, 1000);
    };
}

// === الطلبات ===
function renderOrders(orders) {
    const list = document.getElementById('orders-list') || {};
    list.innerHTML = orders.map(o => `
        <div class="border p-3 rounded mb-2">
            <strong>#${o.id}</strong> ${o.name} - ${o.governorate}
            <button class="btn btn-sm btn-success float-end" onclick="closeOrder(${o.id})">تقفيل</button>
        </div>
    `).join('');
}

function addOrder() {
    const name = prompt('الاسم:');
    const phone = prompt('الهاتف:');
    const gov = prompt('المحافظة:');
    if (name && phone && gov) {
        fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, phone, governorate: gov })
        }).then(loadAllData);
    }
}

function closeOrder(id) {
    const price = prompt('المبلغ:');
    if (price) {
        fetch(`/api/orders/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ closed: true, price })
        }).then(loadAllData);
    }
}

// === المناديب ===
function renderAgents(agents) {
    const list = document.getElementById('agents-list') || {};
    list.innerHTML = agents.map(a => `
        <div class="col-md-4">
            <div class="card p-3 text-center">
                <h6>${a.name}</h6>
                <p>${a.governorate}</p>
            </div>
        </div>
    `).join('');
}

// === التنقل ===
document.querySelectorAll('.nav-link').forEach(l => {
    l.onclick = () => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.getElementById(l.dataset.page).classList.add('active');
        l.classList.add('active');
    };
});